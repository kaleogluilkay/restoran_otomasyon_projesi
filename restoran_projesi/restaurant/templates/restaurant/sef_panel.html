
{% extends 'restaurant/base.html' %}
{% load static %}

{% block title %}Şef Paneli{% endblock %}

{% block content %}


<nav class="navbar navbar-expand-lg navbar-light bg-light px-3 mb-4">
  <div class="container-fluid">
    <span class="navbar-text">
      Şef paneline hoş geldiniz, <strong>{{ request.user.username }}</strong>
    </span>

    <div class="ms-auto">
      <form method="post" action="{% url 'logout' %}" class="d-inline">
        {% csrf_token %}
  <button type="submit" class="btn btn-danger btn-sm">Çıkış Yap</button>
</form>
    </div>
  </div>
</nav>
<div class="container my-4"></div>

  <!-- Mesajlar -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show small" role="alert" 
           style="white-space: pre-line; max-height: 120px; overflow-y: auto;">
        {{ message }}
        <button type="button" class="btn-close btn-sm" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="sefTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="siparisler-tab" data-bs-toggle="tab" data-bs-target="#siparisler" type="button" role="tab" aria-controls="siparisler" aria-selected="true">
        Siparişler
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tarifler-tab" data-bs-toggle="tab" data-bs-target="#tarifler" type="button" role="tab" aria-controls="tarifler" aria-selected="false">
        Tarifler
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="stoklar-tab" data-bs-toggle="tab" data-bs-target="#stoklar" type="button" role="tab" aria-controls="stoklar" aria-selected="false">
        Stok Listesi
      </button>
    </li>
  </ul>

  <div class="tab-content mt-3" id="sefTabContent">
    <!-- Siparişler Tab -->
    <div class="tab-pane fade show active" id="siparisler" role="tabpanel" aria-labelledby="siparisler-tab">

      {% if siparisler %}
      <div class="accordion" id="siparisAccordion">
        {% for siparis in siparisler %}
          <div class="accordion-item">
            <h2 class="accordion-header" id="heading{{ siparis.id }}">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ siparis.id }}" aria-expanded="false" aria-controls="collapse{{ siparis.id }}">
                Masa {% if siparis.masa %}{{ siparis.masa.numara }}{% else %}Bilinmiyor{% endif %}
— Durum: {{ siparis.get_durum_display }} — {{ siparis.tarih_saat|date:"d.m.Y H:i" }}
              </button>
            </h2>
            <div id="collapse{{ siparis.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ siparis.id }}" data-bs-parent="#siparisAccordion">
              <div class="accordion-body">

                <ul class="list-group mb-3">
                  {% for oge in siparis.ogeler.all %}
                    <li class="list-group-item">
                      <a href="#" class="text-decoration-none" data-bs-toggle="collapse" data-bs-target="#malzemeListesi{{ oge.id }}" aria-expanded="false" aria-controls="malzemeListesi{{ oge.id }}">
                        {{ oge.menu.yemek_adi }} × {{ oge.adet }}
                      </a>
                      <div class="collapse mt-2" id="malzemeListesi{{ oge.id }}">
                        <ul class="list-group list-group-flush">
                          {% if oge.menu.tarif %}
                            {% for malzeme in oge.menu.tarif.tarifmalzemesi_set.all %}
                              <li class="list-group-item">
                                {{ malzeme.stok.malzeme_adi }} — {{ malzeme.miktar }} {{ malzeme.stok.birim }}
                              </li>
                            {% endfor %}
                          {% else %}
                            <li class="list-group-item text-muted">Malzeme bilgisi yok.</li>
                          {% endif %}
                        </ul>
                      </div>
                    </li>
                  {% endfor %}
                </ul>

                <form method="POST" action="{% url 'malzeme_kullan' siparis.id %}">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-primary">Malzemeleri Kullan & Hazırlamaya Başla</button>
                </form>

                <form method="POST" action="{% url 'siparis_durum_guncelle' siparis.id %}" class="mt-3">
                  {% csrf_token %}
                  <div class="input-group">
                    <select name="durum" class="form-select">
                      <option value="hazırlanıyor" {% if siparis.durum == 'hazırlanıyor' %}selected{% endif %}>Hazırlanıyor</option>
                      <option value="hazır" {% if siparis.durum == 'hazır' %}selected{% endif %}>Hazır</option>
                    </select>
                    <button class="btn btn-success" type="submit">Durumu Güncelle</button>
                  </div>
                </form>

              </div>
            </div>
          </div>
        {% endfor %}
      </div>
      {% else %}
        <div class="alert alert-info">Bekleyen sipariş yok.</div>
      {% endif %}

    </div>

    <!-- Tarifler Tab -->
    <div class="tab-pane fade" id="tarifler" role="tabpanel" aria-labelledby="tarifler-tab">

      {% if tarifler %}
        <div class="accordion" id="tarifAccordion">
          {% for tarif in tarifler %}
            <div class="accordion-item">
              <h2 class="accordion-header" id="tarifHeading{{ tarif.id }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#tarifCollapse{{ tarif.id }}" aria-expanded="false" aria-controls="tarifCollapse{{ tarif.id }}">
                  {{ tarif.tarif_adi }}
                </button>
              </h2>
              <div id="tarifCollapse{{ tarif.id }}" class="accordion-collapse collapse" aria-labelledby="tarifHeading{{ tarif.id }}" data-bs-parent="#tarifAccordion">
                <div class="accordion-body">
                  <p><strong>Açıklama:</strong> {{ tarif.aciklama|default:"(Açıklama yok)" }}</p>
                  <h6>Malzemeler:</h6>
                  <ul>
                    {% for malzeme in tarif.tarifmalzemesi_set.all %}
                      <li>{{ malzeme.stok.malzeme_adi }} — {{ malzeme.miktar }} {{ malzeme.stok.birim }}</li>
                    {% endfor %}
                  </ul>
                </div>
              </div>
            </div>
            
          {% endfor %}
        </div>
      {% else %}
        <div class="alert alert-info">Hiç tarif yok.</div>
      {% endif %}
      <div class="mt-3 text-end">
        <a href="{% url 'tarif_ekle' %}" class="btn btn-success btn-sm">Yeni Tarif Ekle</a>
      </div>

    </div>

    <!-- Stoklar Tab -->
    <div class="tab-pane fade" id="stoklar" role="tabpanel" aria-labelledby="stoklar-tab">

      {% if stoklar %}
        <table class="table table-striped table-bordered align-middle">
          <thead>
            <tr>
              <th>Malzeme Adı</th>
              <th>Miktar</th>
              <th>Birim</th>
              <th>Birim Fiyat (₺)</th>
            </tr>
          </thead>
          <tbody>
            {% for stok in stoklar %}
              <tr {% if stok.miktar < 5 %}class="table-danger"{% endif %}>
                <td>{{ stok.malzeme_adi }}</td>
                <td>{{ stok.miktar }}</td>
                <td>{{ stok.get_birim_display }}</td>
                <td>{{ stok.birim_fiyat }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="alert alert-info">Stok listesi boş.</div>
      {% endif %}

    </div>
  </div>
</div>
{% endblock %}
